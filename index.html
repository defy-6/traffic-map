<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Traffic Analysis StoryMap</title>

<link href="https://api.mapbox.com/mapbox-gl-js/v3.5.0/mapbox-gl.css" rel="stylesheet"/>
<script src="https://api.mapbox.com/mapbox-gl-js/v3.5.0/mapbox-gl.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
html,body{margin:0;height:100%;font-family:system-ui}
.container{display:flex;height:100%}
#story{
width:32%;
overflow-y:auto;
padding:24px;
background:#f7f7f7;
border-right:1px solid #ddd;
}
#map{flex:1}
section{margin-bottom:80px}
h1{margin-top:0}
h2{margin-top:50px}
.control{margin-top:20px}
.legend{height:14px;border-radius:8px;margin-top:6px}
.slider{width:100%}
button{margin-top:6px}
</style>
</head>

<body>

<div class="container">

<div id="story">

<h1>Traffic Pattern Analysis</h1>
<p>This scroll-driven map explores traffic intensity and modal structure across observed intersections.</p>

<div class="control">
<b>Color Palette</b>
<select id="palette">
<option value="blue">Blue</option>
<option value="red">Red</option>
<option value="green">Green</option>
<option value="purple">Purple</option>
</select>
<div id="legend" class="legend"></div>
<div id="legendLabel"></div>
</div>

<div class="control">
<b>Intersection Size</b>
<input type="range" min="3" max="25" value="8" id="sizeIntersection" class="slider">
</div>

<div class="control">
<label>
<input type="checkbox" id="toggleMedia" checked>
Show Media Points
</label>
</div>

<div class="control">
<b>Media Size</b>
<input type="range" min="2" max="20" value="6" id="sizeMedia" class="slider">
</div>

<div class="control">
<b>Layer Order</b><br>
<button onclick="bringFront('intersection-layer')">Intersections Front</button>
<button onclick="bringFront('media-layer')">Media Front</button>
</div>

<section data-field="count_total">
<h2>Total Traffic Volume</h2>
<p>Overall traffic intensity across intersections.</p>
</section>

<section data-field="count_motorbike">
<h2>Motorbike Count</h2>
<p>Spatial distribution of motorbike flow.</p>
</section>

<section data-field="count_car">
<h2>Car Count</h2>
<p>Car traffic intensity across nodes.</p>
</section>

<section data-field="count_pedestrian">
<h2>Pedestrian Count</h2>
<p>Pedestrian activity level across intersections.</p>
</section>

<section data-field="share_car" data-type="share">
<h2>Car Share</h2>
<p>Proportion of car traffic relative to total traffic.</p>
</section>

<section data-field="share_mc" data-type="share">
<h2>Motorbike Share</h2>
<p>Relative dominance of motorbike trips.</p>
</section>

</div>

<div id="map"></div>

</div>

<script>

mapboxgl.accessToken="pk.eyJ1IjoiZGVmZmllIiwiYSI6ImNtbTNqMmMxODAxaDAycXMyN255eWFwaGIifQ.X5T0rb3Cm_p1wZEYIAGfYQ";

const R2="https://pub-5b55ba14d9c048b3988cab9249645020.r2.dev";

const map=new mapboxgl.Map({
container:"map",
style:"mapbox://styles/mapbox/light-v11",
center:[106.6868,10.7815],
zoom:13
});

map.addControl(new mapboxgl.NavigationControl());

function paletteColors(name){
if(name==="red") return ["#fee5d9","#fcae91","#fb6a4a","#de2d26","#a50f15"];
if(name==="green") return ["#edf8e9","#bae4b3","#74c476","#31a354","#006d2c"];
if(name==="purple") return ["#f2f0f7","#cbc9e2","#9e9ac8","#756bb1","#54278f"];
return ["#eff3ff","#bdd7e7","#6baed6","#3182bd","#08519c"];
}

function updateLegend(min,max,colors,isShare){
document.getElementById("legend").style.background=
`linear-gradient(to right,${colors.join(",")})`;

if(isShare){
document.getElementById("legendLabel").innerText=
`${(min*100).toFixed(1)}% → ${(max*100).toFixed(1)}%`;
}else{
document.getElementById("legendLabel").innerText=
`${min.toFixed(1)} → ${max.toFixed(1)}`;
}
}

function toGeo(rows,lon,lat){
return {
type:"FeatureCollection",
features:rows.filter(r=>r[lon]&&r[lat])
.map(r=>({
type:"Feature",
geometry:{type:"Point",coordinates:[+r[lon],+r[lat]]},
properties:r
}))
};
}

async function loadCSV(name){
return new Promise(res=>{
Papa.parse(R2+"/"+name,{download:true,header:true,complete:r=>res(r.data)});
});
}

async function init(){

const [iRows,mRows]=await Promise.all([
loadCSV("intersection.csv"),
loadCSV("media_locations.csv")
]);

const iGeo=toGeo(iRows,"lon","lat");
const mGeo=toGeo(mRows,"Longitude","Latitude");

map.on("load",()=>{

map.addSource("intersections",{type:"geojson",data:iGeo});
map.addLayer({
id:"intersection-layer",
type:"circle",
source:"intersections",
paint:{
"circle-color":"#3182bd",
"circle-radius":8,
"circle-stroke-width":1,
"circle-stroke-color":"#333"
}
});

map.addSource("media",{type:"geojson",data:mGeo});
map.addLayer({
id:"media-layer",
type:"circle",
source:"media",
paint:{
"circle-color":"#7c3aed",
"circle-radius":6,
"circle-stroke-width":1,
"circle-stroke-color":"#333"
}
});

updateColor("count_total");

});

function updateColor(field){

const palette=paletteColors(document.getElementById("palette").value);
const values=iGeo.features.map(f=>+f.properties[field]).filter(v=>!isNaN(v));
const min=Math.min(...values);
const max=Math.max(...values);
const isShare=field.startsWith("share_");

updateLegend(min,max,palette,isShare);

map.setPaintProperty("intersection-layer","circle-color",[
"interpolate",["linear"],
["to-number",["get",field]],
min,palette[0],
max,palette[4]
]);

}

document.getElementById("palette").addEventListener("change",()=>{
const active=document.querySelector("section.active");
if(active) updateColor(active.dataset.field);
});

document.getElementById("sizeIntersection")
.addEventListener("input",e=>{
map.setPaintProperty("intersection-layer","circle-radius",+e.target.value);
});

document.getElementById("sizeMedia")
.addEventListener("input",e=>{
map.setPaintProperty("media-layer","circle-radius",+e.target.value);
});

document.getElementById("toggleMedia")
.addEventListener("change",e=>{
map.setLayoutProperty("media-layer",
"visibility",e.target.checked?"visible":"none");
});

window.bringFront=function(id){
map.moveLayer(id);
};

map.on("click","intersection-layer",e=>{
const p=e.features[0].properties;
let html="";
for(let k in p){html+=`<b>${k}</b>: ${p[k]}<br>`}
new mapboxgl.Popup().setLngLat(e.lngLat).setHTML(html).addTo(map);
});

map.on("click","media-layer",e=>{
const p=e.features[0].properties;
const url=p.URL||p.url;
let html="";
if(url && url.match(/\.(mp4|mov|webm)$/i)){
html=`<video controls src="${url}" width="250"></video>`;
}else{
html=`<img src="${url}" width="250">`;
}
new mapboxgl.Popup().setLngLat(e.lngLat).setHTML(html).addTo(map);
});

const sections=document.querySelectorAll("section");
const observer=new IntersectionObserver(entries=>{
entries.forEach(entry=>{
if(entry.isIntersecting){
sections.forEach(s=>s.classList.remove("active"));
entry.target.classList.add("active");
updateColor(entry.target.dataset.field);
}
});
},{threshold:0.6});

sections.forEach(s=>observer.observe(s));

}

init();

</script>
</body>
</html>
